{"version":3,"sources":["suba/lib/aotooeventemitter.js"],"names":["sax","eeStock","appendActions","acts","eeActions","actions","act","ii","actValue","target","item","guid","AotooEventEmitter","config","instanceName","_id","Object","defineProperty","data","eeData","create","eeContext","undefined","key","onOpts","fun","after","tmp","call","myFuns","forEach","_fun","push","oneOpts","that","on","off","onceOpts","hasOn","offopts","ccb","_sact","valueFuns","_key","name","param","values","setTimeout","length","emit","apply","arguments","console","log","result","len","value","_sdata","obj","instName","opts"],"mappings":"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","file":"../../../suba/lib/aotooeventemitter.js","sourcesContent":["import {\n  uniqueId,\n  objTypeof,\n  isArray,\n  isObject,\n  isFunction,\n  isString,\n  sizeof,\n  merge,\n  forEach,\n  arr2json,\n  deepFind,\n  protectProperty\n} from './util'\n\nlet eeStock = {}\n\nfunction appendActions(acts){\n  var eeActions = this.eeActions\n  var actions = {}\n  forEach(acts, function(act, ii) {\n    var actValue = acts[act]\n    if (isObject(actValue)) {\n      actions[act] = actValue\n    }\n\n    if (isArray(actValue)) {\n      var target = {}\n      forEach(actValue, function(ii, item) {\n        if (isFunction(item)) {\n          target[(item.guid||ii)] = item\n        }\n      })\n      actions[act] = target\n    }\n\n    if (isFunction(actValue)) {\n      var target = {}\n      target[actValue.guid] = actValue\n      actions[act] = target\n    }\n  })\n  this.eeActions = merge({}, eeActions, actions)\n}\n\n/**\n * AotooEventEmitter\n */\nexport default class AotooEventEmitter {\n  constructor(config={}, instanceName) {\n    this.config = config\n    this._id = config._id\n    this.instanceName = instanceName\n    Object.defineProperty(this, 'eeData', protectProperty({}))\n    Object.defineProperty(this, 'eeActions', protectProperty({}))\n    Object.defineProperty(this, 'eeContext', protectProperty(null))\n    this.data = this.eeData\n    // this.eeData = {}\n    // this.eeActions = {}\n    // this.eeContext = null\n  }\n\n  destyory(){\n    this.eeData = Object.create(null)\n    this.eeActions = Object.create(null)\n    this.eeContext = undefined\n    if (this.instanceName) {\n      eeStock[this.instanceName] = undefined\n    }\n  }\n\n  on(key, onOpts, fun, after) {\n    var tmp = {}\n    if (!fun) fun = onOpts\n    if (isFunction(fun)) {\n      // if (!fun.guid) fun.guid = fun.name || uniqueId('event_')\n      if (!fun.guid) fun.guid = uniqueId('event_')\n      if (after) fun.after = after\n      tmp[key] = fun\n      appendActions.call(this, tmp)\n    }\n    \n    if (isArray(fun)) {\n      var myFuns = []\n      fun.forEach(function (_fun) {\n        if (isFunction(_fun)) {\n          myFuns.push(_fun)  // if (!_fun.guid) _fun.guid = uniqueId('event_')\n        }\n      })\n      tmp[key] = myFuns\n      appendActions.call(this, tmp)\n    }\n\n    if (isObject(fun)) {\n      tmp = fun\n      appendActions.call(this, tmp)\n    }\n  }\n\n  one(key, oneOpts, fun) {\n    if (key) {\n      // this.on(key, oneOpts, fun)\n      // this.set('_one', {[key]: true})\n      const that = this\n      this.on(key, oneOpts, fun, function() {\n        that.off(key, oneOpts, fun)\n      })\n    }\n  }\n\n  once(key, onceOpts, fun){\n    if (key) {\n      if (this.hasOn(key)) {\n        this.off(key)\n      }\n      this.on(key, onceOpts, fun)\n    }\n  }\n\n  off(key, offopts, ccb) {\n    var _sact = this.eeActions\n    if (!ccb) ccb = offopts\n\n    if (isFunction(ccb)) {\n      var valueFuns = _sact[key]\n      forEach(valueFuns, function (_key, ii) {\n        if (valueFuns[_key]) {\n          if (valueFuns[_key].guid == ccb.guid) {\n            // valueFuns[_key] = undefined\n            delete valueFuns[_key]\n          } else if (valueFuns[_key].name == ccb.name) {\n            // valueFuns[_key] = undefined\n            delete valueFuns[_key]\n          }\n        }\n      })\n    } \n    else {\n      _sact[key] = undefined\n    }\n  }\n\n\n  emit(key, param) { \n    var values = []\n    var _sact = this.eeActions\n    var eeContext = this.eeContext\n    param = param || this.eeData\n    if (_sact[key]) {\n      var valueFuns = _sact[key]\n      var target = deepFind(_sact, key)\n\n      // 删除one绑定的方法\n      // if (this.eeData._one && this.eeData._one[key]) {\n      //   setTimeout(() => {\n      //     this.off(key)\n      //   }, 100);\n      // }\n\n      if (isFunction(target)) {\n        if (target.after && isFunction(target.after)) {\n          setTimeout(() => {\n            target.after()\n          }, 100);\n        }\n        return target.call(eeContext, param)\n      }\n      forEach(target, function(key, ii) {\n        var fun = target[key]\n        if (isFunction(fun)) {\n          if (fun.after && isFunction(fun.after)) {\n            setTimeout(() => {\n              fun.after()\n            }, 100);\n          }\n          values.push(fun.call(eeContext, param))\n        }\n      })\n      return values.length == 1 ? values[0] : values\n    }\n  }\n\n  roll() {\n    this.emit.apply(this, arguments)\n  }\n\n  hasOn(key) {\n    var _sact = this.eeActions\n    return _sact[key] ? true : false\n  }\n\n  // has() { }\n  pop(key) {\n    console.log('======== pop api of aotoo EventEmitter that will be deprecated');\n    var _sact = this.eeActions\n    var result\n    if (key) {\n      var target = deepFind(_sact, key)\n      if (target) {\n        var len = sizeof(target)\n        forEach(target, function(key, ii) {\n          if (ii == len-1) {\n            result = target[key]\n            target[key] = undefined\n          }\n        })\n      }\n    }\n    return result\n  }\n\n  trigger() {\n    console.log('======== trigger api of aotoo EventEmitter that is an empty method');\n  }\n\n  //  =====  处理数据  ==========\n  set(key, value) {\n    var _sdata = this.eeData\n    _sdata[key] = value\n    return this\n  }\n  get(key) { \n    var _sdata = this.eeData\n    return key ? deepFind(_sdata, key) : _sdata\n  }\n  append(data) {\n    var _sdata = this.eeData\n    // if (data) this.eeData = merge({}, _sdata, data)\n    if (data) this.eeData = merge(_sdata, data)\n    return this\n  }\n  update(key, data) {\n    if (isString(key)) {\n      var target = deepFind(this.eeData, key)    \n      if (target) {\n        this.eeData[key] = data\n      }\n    }\n    if (isObject(key)) {\n      this.eeData = key\n    }\n  }\n\n  //  =====  处理上下文环境变量  ==========\n  bind(obj) {\n    if (isObject(obj)) this.eeContext = obj\n  }\n  unbind() {\n    this.eeContext = null\n  }\n}\n\nexport function sax(instName, opts) {\n  if (eeStock[instName]) return eeStock[instName]\n  else {\n    eeStock[instName] = new AotooEventEmitter(opts, instName)\n    return eeStock[instName]\n  }\n}"]}